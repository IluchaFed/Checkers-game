<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge">
	<title>Checkers</title>
	<link rel="stylesheet" href="styles.css" type="text/css">
	
	<script src="Graphics.min.js" type="text/javascript"></script>
</head>
<body>
<div class="cap">
	<a href="Index.html" ><img align="left" src="Images\Logo.png"></a>
	<div class="site_heading"> Creating a checkers game</div>
</div>
<div id="wrapper">
	<div class="quote"> Плыву не туда, куда ветер дует, а как парус поставлю</div>
	 
	<div id="game_box"> </div>		
		
</div>
<script>
	
	anychart.onDocumentReady(function(){
	var graphics = acgraph;
	stage = graphics.create('game_box');
	var firstLayer = acgraph.layer();
	firstLayer.parent(stage);
	var rectangle = firstLayer.rect(0, 0, stage.width(), stage.height());
	var ew =0;
	var eb = 0;
	var flag = 1;
	
	//рисуем поле
	for (var j=0; j<8; j++){
			for(var i=0; i<8; i++){
				var rect = firstLayer.rect(
				stage.width()/10*(i),
				stage.height()/10*(j),
				stage.width()/10,
				stage.height()/10
				);
				if((i+j)%2!=0){
					rect.fill("#000000");
				}
				else{
					rect.fill("#FFFFFF");
				}
			}	
		}
	
// конструктор для создания шашки	
	function Checker(x,y, team ){
		
		this.figure = stage.circle(
		(stage.width()/10*(x)+stage.width()/20),   //x
		(stage.height()/10*(y)+stage.height()/20), //y
		stage.height()/24);						//r

		if(team == "white"){
			this.FILL = "white";
			this.notFILL = "#C9CCCA";
			this.strokeFILL = "black";
			this.figure.dir = 1;
			
		}
		if (team == "black"){
			this.FILL = "black";
			this.notFILL = "#7E7E7F";
			this.strokeFILL = "white";
			this.figure.dir = -1;
			
		}
		
		this.team = team;
		
		
		this.figure.FILL = this.FILL;
		this.figure.notFILL = this.notFILL;
		this.figure.fill(this.FILL);
		this.figure.KingFill = this.KingFill;
		this.figure.stroke(this.strokeFILL,2);
		this.figure.drag(rectangle.getBounds());
		this.figure.cursor("hand");
		this.figure.radius =stage.height()/24 ;
		this.figure.x_old = x;
		this.figure.y_old = y;
		this.figure.x_pos = x;
		this.figure.y_pos = y;
		this.figure.team = team;
		this.figure.isKing = false;
		
		
// событие при передвижении шашки
		acgraph.events.listen(this.figure, acgraph.events.EventType.DRAG_END, function (e) {
			this.y_pos =Math.floor((this.getY()+this.radius)/(stage.height()/10) );
			this.x_pos =Math.floor((this.getX()+this.radius)/(stage.width()/10) );
			
			check_moving_checker(this);
			this.fill(this.FILL);
			
		});
// событие при нажатии на шашку		
		acgraph.events.listen(this.figure, acgraph.events.EventType.MOUSEDOWN, function (e) {
			this.fill(this.notFILL);
			
			if(this.isKing){
				console.log( one_more_course_for_king(this));
			}
			else {
					console.log(one_more_course_for_checker(this));
			}
			
		});
		
	//	acgraph.events.listen(this.figure, acgraph.events.EventType.DBLCLICK, function (e) {
	//		this.isKing = !this.isKing;
	//		this.FILL = "#FF0000";
	//		this.fill(this.FILL);
	//		
	//	});
				
	}
//проверка правильности хода


var check_moving_checker= function(fig){
	// если соблюдена очередность ходов: изначально flag=1, у белых dir=1, у черных dir = -1, после каждого хода flag = flag*(-1)
	if (flag*fig.dir==1){
			// x_pre и y_pre  - координаты последней клетки, через которую была перемещена текущая фигура
			if (fig.x_pos-fig.x_old > 0){
				x_pre = -1; 
			}
			else{
				x_pre = 1;
			}
			if(fig.y_pos-fig.y_old > 0){
				y_pre = -1;
			}
			else{
				y_pre = 1;
			}
			
			var x = fig.x_pos+x_pre; 
			var y = fig.y_pos+y_pre; 
			var delta_x = fig.x_pos-fig.x_old;
			var delta_y = fig.y_pos-fig.y_old;
		
			// если не выходим за границы массива и ход совершается по диагонали и на пустую клетку
			if ((Math.abs(delta_x) == Math.abs(delta_y))&&(fig.x_pos>=0)&&(fig.x_pos<8)&&(fig.y_pos>=0)&&(fig.y_pos<8)&&(Board[fig.x_pos][fig.y_pos]==0)){
				//если остались на той же клетке		
				if(Math.abs(delta_x)==0){
					set_old_position(fig);
					console.log("неправильный ход");
				}
				//если  передвинулись на одну клетку 
				else if(Math.abs(delta_x)==1){
					//если перемещаем шашку в правильном направлении и на свободную клетку
					if ((delta_x==1||delta_x==-1)&&(delta_y == fig.dir)){
							// если нет возможности съесть шашку - соперницу 
							if(!eat_avaliable()){
								moving(fig);
								console.log("обычный ход");
							}
							else{
								set_old_position(fig);
								console.log("необходимо рубить код 1!");
							}
					}
					else{
						set_old_position(fig);
						console.log("неправильный ход (код 3)");
					}
				}
				//если перемещаемся на 2 клетки по диагонали шашкой или дамкой
				else if(Math.abs(delta_x)==2){
					// если перемещаемся через шашку
					if(Board[x][y]!=0){
					
						// если шашка, через которую перемещаемся - шашка-соперница
						if (Board[x][y].figure.dir==fig.dir*(-1)){
							eating(Board[x][y]);
							moving(fig);
							if(fig.isKing){
								if(one_more_course_for_king(fig)){
									flag = flag*(-1);
								}
							}
							else {
								if (one_more_course_for_checker(fig)){
									flag = flag * (-1);
								}
							}
							console.log("правильная попытка съесть ");
						}
						// иначе - своя, непраивльно
						else{
							set_old_position(fig);
							console.log("попытка съесть своего");
						}
					}
					// если перемещаемся через пустую клетку дамкой
					else if (Board[x][y]==0 && fig.isKing){
						if(!eat_avaliable()){
								moving(fig);
								console.log("Ход дамкой");
							}
							else{
								set_old_position(fig);
								console.log("необходимо рубить!");
							}
					}
					else {
						set_old_position(fig);
						console.log("неправильный ход (код 4)");
					}
					
				}
				// если передвижение дамкой 
				else if( Math.abs(delta_x)>2 && fig.isKing == true  ){
					// если диагональ пуста		
					if (check_king_moving(fig, x_pre, y_pre, delta_x)){
						//если предыдущая клетка не пуста 
						if (Board[x][y]!=0){
							//если на предыдущей клетке  шашка-соперница
							if (Board[x][y].figure.dir==fig.dir*(-1)){
								eating(Board[x][y]);
								moving(fig);
								
								if(one_more_course_for_king(fig)){
									flag = flag*(-1);
								}
							}// если не шашка соперница, то своя, неправильно
							else{
								set_old_position(fig);
								console.log("попытка съесть своего!");
							}
						
						}
						// если пуста то обычное перемещение
						else{
							if(!eat_avaliable()){
								moving(fig);
								console.log("Ход дамкой");
							}
							else{
								set_old_position(fig);
								console.log("необходимо рубить!");
							}
						
						}
						
					}
					else {
							set_old_position(fig);
							console.log("неправильный ход дамкой");
					}
				}
				else{
					set_old_position(fig);
					console.log("неправильный ход (код 2)");
				}
			}
			else{
				set_old_position(fig);
				console.log("неправильный ход (выход за границы поля или ход на занятую клетку)");
			}
	}
	else {
		set_old_position(fig);
		console.log("не ваш ход!");
	}
};

//передвижение шашки
	var moving = function(fig){
		
		Board[fig.x_pos][fig.y_pos] = Board[fig.x_old][fig.y_old];
		Board[fig.x_old][fig.y_old] = 0;
		fig.setPosition(
				(stage.width()/10*(fig.x_pos)+stage.width()/120), //x
				(stage.height()/10*(fig.y_pos)+stage.height()/120)//y
				);
		
		if(fig.y_pos == 7 && fig.dir == 1){
			fig.isKing = true;
			fig.FILL = "#FFDBC6";
			fig.fill(fig.FILL);
		}
		if (fig.y_pos == 0 && fig.dir == -1){
			fig.isKing = true;
			fig.FILL = "#5E2E27";
			fig.fill(fig.FILL);
		}
		
		fig.x_old = fig.x_pos; 
		fig.y_old = fig.y_pos;
		flag = flag*(-1);
		
		};
//съедание
	var eating = function(Checker){
		
		if( Checker.team == "white"){
		
			Checker.figure.setPosition(
				(stage.width()/10*9+stage.width()/120), //x
				(stage.height()/10+10*ew+stage.height()/120)//y
				);
			ew++;
		}
		else{
			Checker.figure.setPosition(
				(stage.width()/10*9+stage.width()/120), //x
				(stage.height()/10*9+(-10*eb)+stage.height()/120)//y
				);
			eb++
		}
			
		Board[Checker.figure.x_old][Checker.figure.y_old] = 0;
		
		
	}
//возврат шашки на исходную позицию при некорректном ходе
	var set_old_position = function(fig){
		fig.setPosition(
				(stage.width()/10*(fig.x_old)+stage.width()/120), //x
				(stage.height()/10*(fig.y_old)+stage.height()/120)//y
				);
	}
// Проверка наличия еще одного хода для шашки
	var one_more_course_for_checker = function(fig){
		var bool =false;
		var x = fig.x_old;
		var y = fig.y_old;
		
			if ( x-2>=0 && y+2<=7 && Board[x-1][y+1] != 0 ){
				
				if( Board[x-1][y+1].figure.dir==fig.dir*(-1) && Board[x-2][y+2]==0){
					bool = true;
				}
			}
			if( x-2>=0 && y-2>=0 && Board[x-1][y-1] != 0){
				if( Board[x-1][y-1].figure.dir==fig.dir*(-1) && Board[x-2][y-2]==0){
					bool = true;
				}
			}
			if( x+2<=7 && y+2<=7 && Board[x+1][y+1] != 0){
				if( Board[x+1][y+1].figure.dir==fig.dir*(-1) && Board[x+2][y+2]==0){
					bool = true;
				}
			}
			if( x+2<=7 && y-2>=0 && Board[x+1][y-1] != 0){
				if( Board[x+1][y-1].figure.dir==fig.dir*(-1) && Board[x+2][y-2]==0){
					bool = true;
				}
			}
			//console.log(bool);
			return bool;  
		
	}
//////////////////////////////////////////////////
// вызывает dop-function для каждого направления
	var one_more_course_for_king = function(fig){
		var bool1=dop_function(fig, -1, 1);
		var bool2=dop_function(fig, 1, -1);
		var bool3=dop_function(fig, 1, 1);
		var bool4=dop_function(fig, -1, -1);
		return bool1||bool2||bool3||bool4;
	}
////////////////////////////////////////////////////////////////////////
// возвращает true если  в выбранном направлении возможно съесть шашку-соперницу
	var dop_function = function(fig, dir_x, dir_y){
		var bool = false;
		var x= fig.x_old;
		var y= fig.y_old;
		
		for(var z=1;z<7; z++){
			//если не выходим за границы массива
			if(x+dir_x*(z+1)>=0 && x+dir_x*(z+1)<=7 && y+dir_y*(z+1)>=0 && y+dir_y*(z+1)<=7){
			
				if (Board[x+dir_x*z][y+dir_y*z]!=0){
					if(Board[x+dir_x*z][y+dir_y*z].figure.dir == (-1)*fig.dir){
						if(Board[x+dir_x*(z+1)][y+dir_y*(z+1)]==0){
							bool =true;
							break;
						}
						else{
							console.log("метка 3");
							break;
						}
					}
					else{
						console.log("метка 2");
						break;
					}
				}
	
			}
			// иначе 
			else {
				console.log("метка 1");
				break;
			}
				
		}
		
		return bool;
		
	}
/////////////////////////////////////////////////////////////////////////
//Проверка наличия возможности съесть шашку соперницу текущей командой
	var eat_avaliable = function(){
		var eatable = false;
		//если флаг =1 то проверить всех белых шашек
		for (var j=0; j<8; j++){
			for(var i=0; i<8; i++){
				if(Board[i][j]!=0 && !Board[i][j].figure.isKing ){
					
					if ((flag == 1) && (Board[i][j].team == "white") && (one_more_course_for_checker(Board[i][j].figure))){
					eatable = true;
					break;
					}
					if ((flag == -1) && (Board[i][j].team == "black") && (one_more_course_for_checker(Board[i][j].figure))){
					eatable = true;
					break;
					}
				}
				else if(Board[i][j]!=0 && Board[i][j].figure.isKing ){
					if ((flag == 1) && (Board[i][j].team == "white") && (one_more_course_for_king(Board[i][j].figure))){
						eatable = true;
						break;
					}
					if ((flag == -1) && (Board[i][j].team == "black") && (one_more_course_for_king(Board[i][j].figure))){
						eatable = true;
						break;
					}
					
				}
			}
				
			
		}
		
		return eatable;
	} 
/////////////////////////////////////////////////////////////////////////////////////////////////////	
// ф-я для проверки хода дамкой, true если диагональ кроме последней клетки пустая
	var check_king_moving = function(fig, x_dir, y_dir, delta){
		var bool = true;
		
		for(var i=1;i<delta-1; i++){
			if(Board[fig.x_old - x_dir*(i)][fig.y_old-y_dir*(i)]!=0){
				bool=false;
			}
		}
		return bool;
	}

/////////////////////////////////////////////////////////////////////////////////
		//var l = new Checker(50,50);
		var Board = new Array();
		
		
		for ( i = 0; i<8; i++){
			Board[i] = new Array();
			for ( var j = 0; j<8; j++){
				if(j<3){
					if((i+j)%2!=0 ){
						Board[i][j] = new Checker (i,j,"white");
					}
					else{
						Board[i][j] = 0;
					}
				
				}
				else if(j>4){
					if((i+j)%2!=0 ){
						Board[i][j] = new Checker (i,j,"black");
					}
					else{
						Board[i][j] = 0;
					}
				}
				else{
					Board[i][j] = 0;
				}	
			}
		}
////////////////////////////////////////////////////////////////////////////
	var print_Board = function(){
			for ( i = 0; i<8; i++){
				for ( var j = 0; j<8; j++){
					console.log(Board[i][j]);
				}
			}
		}
		
		
		
	}
	)
	

</script>
</body>
</html>
